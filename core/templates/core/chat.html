{% extends 'core/base.html' %}
{% load static %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}

<div class="chat-container" style="max-width:600px; margin:auto; position:relative;">
Â  <h3>Chat with {{ other_user.username }}</h3>

Â  Â  <div id="messages" style="height:400px; overflow-y:auto; border:1px solid #ccc; border-radius:10px; padding:10px; margin-bottom:10px; position:relative;">
Â  Â  {% for msg in messages %}
Â  Â  Â  <div class="message" id="msg-{{ msg.id }}" style="margin-bottom:8px;">
Â  Â  Â  Â  <strong>{{ msg.sender.username }}:</strong>

Â  Â  Â  Â  {% if msg.content %}
Â  Â  Â  Â  Â  <div>{{ msg.content }}</div>
Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  {% if msg.image %}
Â  Â  Â  Â  Â  <div><img src="{{ msg.image.url }}" style="max-width:90%; border-radius:6px;"></div>
Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  {% if msg.audio %}
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <audio controls preload="none" style="width:90%;">
Â  Â  Â  Â  Â  Â  Â  <source src="{{ msg.audio.url }}" type="audio/mpeg">
Â  Â  Â  Â  Â  Â  </audio>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  {% endif %}

Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  {% if msg.sender == request.user %}
Â  Â  Â  Â  Â  Â  <button class="delete-btn btn btn-sm btn-outline-danger" data-id="{{ msg.id }}" data-action="delete_for_me">Delete for me</button>
Â  Â  Â  Â  Â  Â  <button class="delete-btn btn btn-sm btn-outline-warning" data-id="{{ msg.id }}" data-action="delete_for_everyone">Delete for everyone</button>
Â  Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  <button class="delete-btn btn btn-sm btn-outline-danger" data-id="{{ msg.id }}" data-action="delete_for_me">Delete for me</button>
Â  Â  Â  Â  Â  {% endif %}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  {% endfor %}

Â  Â  Â  Â  <div class="message ad-message" id="chat-ad" style="margin-bottom:8px; text-align:center; font-size:10px; color:#888; cursor:pointer;">
Â  Â  Â  Click-to-view ad
Â  Â  </div>

Â  Â  Â  Â  <div id="ad-placeholder" style="display:none; border:1px solid #ccc; border-radius:6px; padding:10px; margin:5px 0; text-align:center; color:#555; font-size:12px;">
Â  Â  Â  Double-click to close
Â  Â  </div>

Â  </div>

Â  Â  <div id="chat-controls" style="display:flex; align-items:center; gap:6px; **background-color: white; z-index: 1000;**">
Â  Â  <label for="fileInput" style="cursor:pointer;">ðŸ“Ž
Â  Â  Â  <input type="file" id="fileInput" accept="image/*,audio/*" style="display:none;">
Â  Â  </label>

Â  Â  <input id="msg" class="form-control" placeholder="Type a message..." style="flex:1;">
Â  Â  <button id="send" class="btn btn-primary">Send</button>
Â  Â  <button id="mic" class="btn btn-outline-secondary">ðŸŽ¤</button>
Â  </div>

Â  Â  <div id="record-status" style="display:none; margin-top:8px; text-align:center;">
Â  Â  <span id="timer">0:00</span> â€¢ Recording... (<a href="#" id="cancel-record">Cancel</a>)
Â  Â  <button id="send-audio-btn" class="btn btn-success btn-sm ms-2" style="display:none;">Send Audio</button>
Â  </div>
</div>

<script>
/* -------------------- UTILITY -------------------- */
function getCookie(name) {
Â  Â  let cookieValue = null;
Â  Â  if (document.cookie && document.cookie !== '') {
Â  Â  Â  Â  document.cookie.split(';').forEach(cookie => {
Â  Â  Â  Â  Â  Â  cookie = cookie.trim();
Â  Â  Â  Â  Â  Â  if (cookie.startsWith(name + '=')) {
Â  Â  Â  Â  Â  Â  Â  Â  cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }
Â  Â  return cookieValue;
}

/* -------------------- VARIABLES -------------------- */
const messagesBox = document.getElementById("messages");
const msgInput Â  Â  = document.getElementById("msg");
const sendBtn Â  Â  Â = document.getElementById("send");
const micBtn Â  Â  Â  = document.getElementById("mic");
const recordStatus = document.getElementById("record-status");
const timerEl Â  Â  Â = document.getElementById("timer");
const cancelRecord = document.getElementById("cancel-record");
const currentUser Â = "{{ request.user.username }}";

const chatAd = document.getElementById("chat-ad");
const adPlaceholder = document.getElementById("ad-placeholder");

let mediaRecorder = null;
let audioChunks = [];
let recordingInterval = null;
let seconds = 0;

/* -------------------- APPEND MESSAGE -------------------- */
function appendMessage(data) {
Â  Â  if (document.getElementById(`msg-${data.message_id}`)) return;

Â  Â  const div = document.createElement("div");
Â  Â  div.classList.add("message");
Â  Â  div.id = `msg-${data.message_id}`;
Â  Â  div.style.marginBottom = "8px";

Â  Â  let html = `<strong>${data.sender}:</strong>`;
Â  Â  if (data.content) html += `<div>${data.content}</div>`;
Â  Â  if (data.image) Â  html += `<div><img src="${data.image}" style="max-width:90%; border-radius:6px;"></div>`;
Â  Â  if (data.audio) Â  html += `<div><audio controls src="${data.audio}" style="width:90%;"></audio></div>`;

Â  Â  // DELETE BUTTONS FOR ALL MESSAGES
Â  Â  html += `<div>`;
Â  Â  if (data.sender === currentUser) {
Â  Â  Â  Â  html += `<button class="delete-btn btn btn-sm btn-outline-danger" data-id="${data.message_id}" data-action="delete_for_me">Delete for me</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="delete-btn btn btn-sm btn-outline-warning" data-id="${data.message_id}" data-action="delete_for_everyone">Delete for everyone</button>`;
Â  Â  } else {
Â  Â  Â  Â  html += `<button class="delete-btn btn btn-sm btn-outline-danger" data-id="${data.message_id}" data-action="delete_for_me">Delete for me</button>`;
Â  Â  }
Â  Â  html += `</div>`;

Â  Â  div.innerHTML = html;

Â  Â  // Insert above the ad placeholder
Â  Â  messagesBox.insertBefore(div, chatAd);
Â  Â  messagesBox.scrollTop = messagesBox.scrollHeight;
}

/* -------------------- DELETE BUTTONS (EVENT DELEGATION) -------------------- */
messagesBox.addEventListener("click", async (e) => {
Â  Â  if (!e.target.classList.contains("delete-btn")) return;

Â  Â  const id = e.target.dataset.id;
Â  Â  const action = e.target.dataset.action;
Â  Â  const csrftoken = getCookie("csrftoken");

Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`/delete-message/${id}/${action}/`, {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "X-CSRFToken": csrftoken }
Â  Â  Â  Â  });
Â  Â  Â  Â  if (res.ok) {
Â  Â  Â  Â  Â  Â  const msgDiv = document.getElementById(`msg-${id}`);
Â  Â  Â  Â  Â  Â  msgDiv?.remove();
Â  Â  Â  Â  }
Â  Â  } catch (err) { console.error(err); }
});

/* -------------------- CLICKABLE AD -------------------- */
chatAd.addEventListener("click", () => {
Â  Â  adPlaceholder.style.display = "block";
Â  Â  adPlaceholder.textContent = "Double-click to close";
});

adPlaceholder.addEventListener("dblclick", () => {
Â  Â  adPlaceholder.style.display = "none";
});

/* -------------------- SEND TEXT MESSAGE -------------------- */
sendBtn.addEventListener("click", async () => {
Â  Â  const content = msgInput.value.trim();
Â  Â  if (!content) return;

Â  Â  const csrftoken = getCookie("csrftoken");
Â  Â  try {
Â  Â  Â  Â  const res = await fetch("{% url 'send_message' other_user.username %}", {
Â  Â  Â  Â  Â  Â  method: "POST",
Â  Â  Â  Â  Â  Â  headers: { "X-CSRFToken": csrftoken, "Content-Type": "application/json" },
Â  Â  Â  Â  Â  Â  body: JSON.stringify({ content: content })
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  appendMessage(data);
Â  Â  Â  Â  msgInput.value = "";
Â  Â  } catch (err) { console.error(err); }
});

/* -------------------- VOICE RECORDING -------------------- */
micBtn.addEventListener("click", async () => {
Â  Â  if (!mediaRecorder || mediaRecorder.state === "inactive") {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  Â  Â  Â  Â  mediaRecorder = new MediaRecorder(stream);
Â  Â  Â  Â  Â  Â  audioChunks = [];
Â  Â  Â  Â  Â  Â  seconds = 0;

Â  Â  Â  Â  Â  Â  mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
Â  Â  Â  Â  Â  Â  mediaRecorder.onstop = sendAudioMessage;

Â  Â  Â  Â  Â  Â  mediaRecorder.start();
Â  Â  Â  Â  Â  Â  recordStatus.style.display = "block";
Â  Â  Â  Â  Â  Â  timerEl.textContent = "0:00";
             micBtn.textContent = "ðŸ›‘"; // Change button text to stop icon

Â  Â  Â  Â  Â  Â  recordingInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  seconds++;
Â  Â  Â  Â  Â  Â  Â  Â  const min = Math.floor(seconds / 60);
Â  Â  Â  Â  Â  Â  Â  Â  const sec = seconds % 60;
Â  Â  Â  Â  Â  Â  Â  Â  timerEl.textContent = `${min}:${sec.toString().padStart(2,'0')}`;
Â  Â  Â  Â  Â  Â  }, 1000);

Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  alert("Microphone access denied. Ensure your site uses HTTPS.");
Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  }
Â  Â  } else if (mediaRecorder.state === "recording") {
Â  Â  Â  Â  mediaRecorder.stop();
Â  Â  Â  Â  clearInterval(recordingInterval);
Â  Â  Â  Â  recordStatus.style.display = "none";
Â  Â  Â  Â  micBtn.textContent = "ðŸŽ¤"; // Reset button text
Â  Â  }
});

cancelRecord.addEventListener("click", (e) => {
Â  Â  e.preventDefault();
Â  Â  if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
Â  Â  audioChunks = [];
Â  Â  clearInterval(recordingInterval);
Â  Â  recordStatus.style.display = "none";
Â  Â  micBtn.textContent = "ðŸŽ¤"; // Reset button text
});

async function sendAudioMessage() {
Â  Â  const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
Â  Â  const formData = new FormData();
Â  Â  formData.append('audio', audioBlob);

Â  Â  const csrftoken = getCookie("csrftoken");

Â  Â  try {
Â  Â  Â  Â  const res = await fetch("{% url 'send_message' other_user.username %}", {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'X-CSRFToken': csrftoken },
Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  });
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  appendMessage(data);
Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  }

Â  Â  audioChunks = [];
}

/* -------------------- LIVE CHAT POLLING -------------------- */
function fetchNewMessages() {
Â  Â  const lastId = getLastMessageId();
Â  Â  fetch("{% url 'chat_room' other_user.username %}?last_id=" + lastId)
Â  Â  Â  Â  .then(res => res.json())
Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  if (data.messages) data.messages.forEach(msg => appendMessage(msg));
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(err => console.error(err));
}

function getLastMessageId() {
Â  Â  const msgs = messagesBox.querySelectorAll(".message");
Â  Â  return msgs.length ? msgs[msgs.length - 1].id.split("-")[1] : 0;
}

setInterval(fetchNewMessages, 2000);

/* Scroll to bottom on load */
window.onload = function() {
    messagesBox.scrollTop = messagesBox.scrollHeight;
};
</script>

{% endblock %}