{% extends 'core/base.html' %}

{% block content %}

<div class="d-flex align-items-center">
    
    <img src="{{ user_profile.profile_image_url }}" width="80" height="80" class="rounded-circle me-3">

    <div>
        <h3>{{ user_profile.username }}</h3>
        <p>{{ user_profile.bio }}</p>

        <p>
            <span id="followers">{{ followers_count }}</span> followers â€¢
            <span id="following">{{ following_count }}</span> following
        </p>

        {% if user != user_profile %}
            <button id="follow-btn"
                    class="btn btn-outline-primary"
                    data-username="{{ user_profile.username }}">
                {% if is_following %}Unfollow{% else %}Follow{% endif %}
            </button>
        {% endif %}
    </div>
</div>

<hr>

<h4>Posts</h4>
<div class="row">
    {% for post in posts %}
        <div class="col-md-4 mb-3">
            <img src="{{ post.image.url }}" class="img-fluid">
            <p>{{ post.caption }}</p>
        </div>
    {% empty %}
        <p>No posts yet.</p>
    {% endfor %}
</div>

<script>
// -------------------- CSRF UTILITY --------------------
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(c => {
            c = c.trim();
            if (c.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(c.slice(name.length + 1));
            }
        });
    }
    return cookieValue;
}

// -------------------- FOLLOW BUTTON --------------------
const followBtn = document.getElementById("follow-btn");
followBtn?.addEventListener("click", async function () {
    const username = this.dataset.username;
    const csrftoken = getCookie('csrftoken');

    try {
        const res = await fetch(`/follow/${username}/`, {
            method: "POST",
            headers: { "X-CSRFToken": csrftoken }
        });

        const data = await res.json();

        if (data.state === "unfollow") {
            this.textContent = "Unfollow";
        } else {
            this.textContent = "Follow";
        }

        // Update follower/following counts
        document.getElementById("followers").textContent = data.followers_count;
        document.getElementById("following").textContent = data.following_count;

    } catch (err) {
        console.error("Follow/unfollow error:", err);
    }
});
</script>

{% endblock %}
