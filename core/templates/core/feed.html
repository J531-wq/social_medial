{% extends 'core/base.html' %}
{% load static %}

{% block title %}Your Feed{% endblock %}

{% block content %}

<!-- USERS HORIZONTAL LIST -->
<div style="display: flex; overflow-x: auto; padding: 10px; gap: 15px; border-bottom: 1px solid #eee;">
    {% for u in all_users %}
        <div style="text-align: center;">
            <a href="{% url 'profile' u.username %}" style="text-decoration: none; color: inherit;">
                {% if u.profile_image %}
                    <img src="{{ u.profile_image.url }}" alt="{{ u.username }}" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
                {% else %}
                    <img src="{% static 'default_profile.png' %}" alt="default profile" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
                {% endif %}
            </a>
            <div style="font-size: 12px; margin-top:5px;">{{ u.username }}</div>
            {% if u != request.user %}
                <a href="{% url 'chat_room' u.username %}" class="btn btn-sm btn-outline-primary mt-1" style="display:block; font-size:10px;">
                    Message
                </a>
            {% endif %}
        </div>
    {% endfor %}
</div>

<h3>Your Feed</h3>

{% for post in posts %}
<div class="card my-3" data-post-id="{{ post.id }}">
    <div class="card-body">
        <h5>{{ post.author.username }}</h5>

        {% if post.image %}
            <img src="{{ post.image.url }}" class="img-fluid rounded mb-2">
        {% endif %}

        <p>{{ post.caption }}</p>

        <!-- Like Button (AJAX) -->
        <button class="btn btn-outline-primary like-btn" data-post-id="{{ post.id }}">
            ❤️ <span class="like-count">{{ post.total_likes }}</span> Like{{ post.total_likes|pluralize }}
        </button>

        <!-- Comments Section -->
        <div class="mt-3">
            <h6>Comments</h6>
            <ul class="list-group list-group-flush mb-2 comments-list">
                {% for comment in post.comments.all %}
                    <li class="list-group-item">
                        <strong>{{ comment.user.username }}:</strong> {{ comment.text }}
                    </li>
                {% empty %}
                    <li class="list-group-item text-muted">No comments yet.</li>
                {% endfor %}
            </ul>

            <div class="input-group">
                <input type="text" class="form-control comment-input" placeholder="Add a comment..." required>
                <button class="btn btn-primary comment-btn" data-post-id="{{ post.id }}">Comment</button>
            </div>
        </div>
    </div>
</div>

<!-- Tiny Auto-view Ad -->
<div class="auto-view-ad" data-post-id="{{ post.id }}">
    <p style="font-size:10px; margin:0; text-align:center;">Sponsored</p>
</div>

{% empty %}
<p>No posts yet.</p>
{% endfor %}

<!-- Fixed click-to-view ad -->
<div id="fixedClickAd" title="Click to view ad">
    <p style="font-size: 10px; margin: 0; text-align:center;">Ad</p>
</div>

<style>
.auto-view-ad {
    width: 60px; height:60px;
    background:#eee; border:1px solid #ccc; border-radius:6px;
    text-align:center; line-height:60px; font-size:10px;
    margin:10px auto; cursor:pointer;
}
#fixedClickAd {
    position:fixed; top:70px; right:10px;
    width:60px; height:60px;
    background:#ddd; border:1px solid #ccc; border-radius:6px;
    text-align:center; line-height:60px; font-size:10px; z-index:1050; cursor:pointer;
}
#fixedClickAd.expanded {
    width:200px; height:250px; line-height:normal; padding:10px;
}
</style>

<script>
function getCookie(name){
    let cookieValue=null;
    if(document.cookie && document.cookie!==''){
        document.cookie.split(';').forEach(c=>{
            c=c.trim();
            if(c.startsWith(name+'=')) cookieValue=decodeURIComponent(c.slice(name.length+1));
        });
    }
    return cookieValue;
}

/* -------------------- LIKE BUTTONS -------------------- */
document.querySelectorAll('.like-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
        const postId = btn.dataset.postId;
        const csrftoken = getCookie('csrftoken');
        try{
            const res = await fetch(`/post/${postId}/like/`, {
                method:'POST', headers:{'X-CSRFToken': csrftoken}
            });
            if(res.ok){
                const countSpan = btn.querySelector('.like-count');
                const current = parseInt(countSpan.textContent) || 0;
                // Toggle like count (simple approach)
                countSpan.textContent = btn.classList.contains('liked') ? current-1 : current+1;
                btn.classList.toggle('liked');
            }
        }catch(err){ console.error(err); }
    });
});

/* -------------------- COMMENTS -------------------- */
document.querySelectorAll('.comment-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
        const postId = btn.dataset.postId;
        const input = btn.closest('.input-group').querySelector('.comment-input');
        const text = input.value.trim();
        if(!text) return;

        const csrftoken = getCookie('csrftoken');
        try{
            const formData = new FormData();
            formData.append('text', text);

            const res = await fetch(`/post/${postId}/comment/`, {
                method:'POST',
                headers:{'X-CSRFToken': csrftoken},
                body:formData
            });
            if(res.ok){
                // Append comment to list
                const ul = btn.closest('.card-body').querySelector('.comments-list');
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.innerHTML = `<strong>{{ request.user.username }}:</strong> ${text}`;
                ul.appendChild(li);
                input.value='';
            }
        }catch(err){ console.error(err); }
    });
});

/* -------------------- AUTO-VIEW ADS -------------------- */
const autoAds = document.querySelectorAll('.auto-view-ad');
function isInViewport(el){
    const rect=el.getBoundingClientRect();
    return rect.top<window.innerHeight && rect.bottom>=0;
}
function trackImpressions(){
    autoAds.forEach(ad=>{
        if(!ad.dataset.viewed && isInViewport(ad)){
            ad.dataset.viewed='true';
            console.log(`Auto-view ad for post ${ad.dataset.postId} counted`);
        }
    });
}
window.addEventListener('scroll', trackImpressions);
window.addEventListener('load', trackImpressions);

/* -------------------- FIXED CLICK-TO-VIEW AD -------------------- */
const clickAd=document.getElementById('fixedClickAd');
clickAd.addEventListener('click', ()=>{
    clickAd.classList.toggle('expanded');
    clickAd.innerHTML = clickAd.classList.contains('expanded') ? "<h4 style='text-align:center;'>Full Ad Content Here</h4>" : "<p style='font-size:10px;margin:0;text-align:center;'>Ad</p>";
});
</script>

{% endblock %}
